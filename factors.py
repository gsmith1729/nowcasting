import numpy as np
import pandas as pd
import re
import types
import statsmodels.api as sm

import matplotlib.pyplot as plt

#import the data
df = pd.read_csv("final_data.csv",dayfirst=True,index_col='date', parse_dates = True)
start="01/01/1959"
end="01/01/2022"
# change the index to the date
df.index = pd.DatetimeIndex(df.index).to_period('M')

short_var = ['ACOGNO',
 'ACOGNO',
 'ANDENOx.x',
 'TWEXAFEGSMTHx.x',
 'UMCSENTx.x',
 'OUTMS',
 'TCU',
 'LNS13023621',
 'LNS13023557',
 'LNS13023705',
 'LNS13023569',
 'AWHNONAG',
 'ACOGNOx',
 'ANDENOx.y',
  'INVCQRMTSPL',
  'WPU0531',
  'AHETPIx',
  'COMPRMS',
  'OPHMFG',
  'ULCMFG',
  'MORTGAGE30US',
  'MORTG10YRx',
  'REVOLSLx',
  'DRIWCIL',
  'USSTHPI',
  'SPCS10RSA',
  'SPCS20RSA',
  'TWEXAFEGSMTHx.y',
  'EXUSEU',
  'USEPUINDXM',
  'GFDEGDQ188S',
  'GFDEBTNx',
  'NASDAQCOM',
  'CUSR0000SEHC']

monthly_var = "[RPI,W875RX1,DPCERA3M086SBEA,CMRMTSPLx.x,RETAILx,INDPRO.x,IPFPNSS,IPFINAL.x,IPCONGD.x,IPDCONGD.x,IPNCONGD.x,IPBUSEQ.x,IPMAT.x,IPDMAT.x,IPNMAT.x,IPMANSICS.x,IPB51222S.x,IPFUELS.x,CUMFNS.x,HWI,HWIURATIO,CLF16OV,CE16OV.x,UNRATE.x,UEMPMEAN.x,UEMPLT5.x,UEMP5TO14.x,UEMP15OV,UEMP15T26.x,UEMP27OV.x,CLAIMSx.x,PAYEMS.x,USGOOD.x,CES1021000001,USCONS.x,MANEMP.x,DMANEMP.x,NDMANEMP.x,SRVPRD.x,USTPU.x,USWTRADE.x,USTRADE.x,USFIRE.x,USGOVT.x,CES0600000007.x,AWOTMAN.x,AWHMAN.x,HOUST.x,HOUSTNE.x,HOUSTMW.x,HOUSTS.x,HOUSTW.x,PERMIT.x,PERMITNE.x,PERMITMW.x,PERMITS.x,PERMITW.x,ACOGNO,AMDMNOx.x,ANDENOx.x,AMDMUOx.x,BUSINVx.x,ISRATIOx.x,M1SL,M2SL,M2REAL.x,BOGMBASE,TOTRESNS.x,NONBORRES.x,BUSLOANS,REALLN,NONREVSL,CONSPI,S&P 500.x,S&P: indust.x,S&P div yield.x,S&P PE ratio.x,FEDFUNDS.x,CP3Mx,TB3MS.x,TB6MS.x,GS1.x,GS5.x,GS10.x,AAA.x,BAA.x,COMPAPFFx,TB3SMFFM.x,TB6SMFFM,T1YFFM,T5YFFM.x,T10YFFM,AAAFFM.x,BAAFFM,TWEXAFEGSMTHx.x,EXSZUSx.x,EXJPUSx.x,EXUSUKx.x,EXCAUSx.x,WPSFD49207.x,WPSFD49502.x,WPSID61.x,WPSID62.x,OILPRICEx.x,PPICMM.x,CPIAUCSL.x,CPIAPPSL.x,CPITRNSL.x,CPIMEDSL.x,CUSR0000SAC.x,CUSR0000SAD.x,CUSR0000SAS.x,CPIULFSL.x,CUSR0000SA0L2.x,CUSR0000SA0L5.x,PCEPI,DDURRG3M086SBEA,DNDGRG3M086SBEA,DSERRG3M086SBEA,CES0600000008.x,CES2000000008,CES3000000008,UMCSENTx.x,DTCOLNVHFNM.x,DTCTHFNM.x,INVEST.x,VIXCLSx.x]"
quarterly_var = "[GDPC1,PCECC96,PCDGx,PCESVx,PCNDx,GPDIC1,FPIx,Y033RC1Q027SBEAx,PNFIx,PRFIx,A014RE1Q156NBEA,GCEC1,A823RL1Q225SBEA,FGRECPTx,SLCEx,EXPGSC1,IMPGSC1,DPIC96,OUTNFB,OUTBS,OUTMS,INDPRO.y,IPFINAL.y,IPCONGD.y,IPMAT.y,IPDMAT.y,IPNMAT.y,IPDCONGD.y,IPB51110SQ,IPNCONGD.y,IPBUSEQ.y,IPB51220SQ,TCU,CUMFNS.y,PAYEMS.y,USPRIV,MANEMP.y,SRVPRD.y,USGOOD.y,DMANEMP.y,NDMANEMP.y,USCONS.y,USEHS,USFIRE.y,USINFO,USPBS,USLAH,USSERV,USMINE,USTPU.y,USGOVT.y,USTRADE.y,USWTRADE.y,CES9091000001,CES9092000001,CES9093000001,CE16OV.y,CIVPART,UNRATE.y,UNRATESTx,UNRATELTx,LNS14000012,LNS14000025,LNS14000026,UEMPLT5.y,UEMP5TO14.y,UEMP15T26.y,UEMP27OV.y,LNS13023621,LNS13023557,LNS13023705,LNS13023569,LNS12032194,HOABS,HOAMS,HOANBS,AWHMAN.y,AWHNONAG,AWOTMAN.y,HWIx,HOUST.y,HOUST5F,PERMIT.y,HOUSTMW.y,HOUSTNE.y,HOUSTS.y,HOUSTW.y,CMRMTSPLx.y,RSAFSx,AMDMNOx.y,ACOGNOx,AMDMUOx.y,ANDENOx.y,INVCQRMTSPL,PCECTPI,PCEPILFE,GDPCTPI,GPDICTPI,IPDBS,DGDSRG3Q086SBEA,DDURRG3Q086SBEA,DSERRG3Q086SBEA,DNDGRG3Q086SBEA,DHCERG3Q086SBEA,DMOTRG3Q086SBEA,DFDHRG3Q086SBEA,DREQRG3Q086SBEA,DODGRG3Q086SBEA,DFXARG3Q086SBEA,DCLORG3Q086SBEA,DGOERG3Q086SBEA,DONGRG3Q086SBEA,DHUTRG3Q086SBEA,DHLCRG3Q086SBEA,DTRSRG3Q086SBEA,DRCARG3Q086SBEA,DFSARG3Q086SBEA,DIFSRG3Q086SBEA,DOTSRG3Q086SBEA,CPIAUCSL.y,CPILFESL,WPSFD49207.y,PPIACO,WPSFD49502.y,WPSFD4111,PPIIDC,WPSID61.y,WPU0531,WPU0561,OILPRICEx.y,AHETPIx,CES2000000008x,CES3000000008x,COMPRMS,COMPRNFB,RCPHBS,OPHMFG,OPHNFB,OPHPBS,ULCBS,ULCMFG,ULCNFB,UNLPNBS,FEDFUNDS.y,TB3MS.y,TB6MS.y,GS1.y,GS10.y,MORTGAGE30US,AAA.y,BAA.y,BAA10YM,MORTG10YRx,TB6M3Mx,GS1TB3Mx,GS10TB3Mx,CPF3MTB3Mx,BOGMBASEREALx,M1REAL,M2REAL.y,BUSLOANSx,CONSUMERx,NONREVSLx,REALLNx,REVOLSLx,TOTALSLx,DRIWCIL,TABSHNOx,TLBSHNOx,LIABPIx,TNWBSHNOx,NWPIx,TARESAx,HNOREMQ027Sx,TFAABSHNOx,VIXCLSx.y,USSTHPI,SPCS10RSA,SPCS20RSA,TWEXAFEGSMTHx.y,EXUSEU,EXSZUSx.y,EXJPUSx.y,EXUSUKx.y,EXCAUSx.y,UMCSENTx.y,USEPUINDXM,B020RE1Q156NBEA,B021RE1Q156NBEA,GFDEGDQ188S,GFDEBTNx,IPMANSICS.y,IPB51222S.y,IPFUELS.y,UEMPMEAN.y,CES0600000007.y,TOTRESNS.y,NONBORRES.y,GS5.y,TB3SMFFM.y,T5YFFM.y,AAAFFM.y,WPSID62.y,PPICMM.y,CPIAPPSL.y,CPITRNSL.y,CPIMEDSL.y,CUSR0000SAC.y,CUSR0000SAD.y,CUSR0000SAS.y,CPIULFSL.y,CUSR0000SA0L2.y,CUSR0000SA0L5.y,CES0600000008.y,DTCOLNVHFNM.y,DTCTHFNM.y,INVEST.y,HWIURATIOx,CLAIMSx.y,BUSINVx.y,ISRATIOx.y,CONSPIx,CP3M,COMPAPFF,PERMITNE.y,PERMITMW.y,PERMITS.y,PERMITW.y,NIKKEI225,NASDAQCOM,CUSR0000SEHC,TLBSNNCBx,TLBSNNCBBDIx,TTAABSNNCBx,TNWMVBSNNCBx,TNWMVBSNNCBBDIx,TLBSNNBx,TLBSNNBBDIx,TABSNNBx,TNWBSNNBx,TNWBSNNBBDIx,CNCFx,S&P 500.y,S&P: indust.y,S&P div yield.y,S&P PE ratio.y]"
monthly_var = monthly_var.strip('][').split(',')
quarterly_var = quarterly_var.strip('][').split(',')

# Standardise
for var in df.columns:
    # De-mean and standardize
    df[var]=(df[var]- df[var].mean())/df[var].std()

df.drop(columns="GDPC1in")
df.drop(columns="GDPC1out")

endog_vars=monthly_var
# specify the variables on which the factor structure will depend
endog=df.loc[start:end, endog_vars]
for i in short_var:
    if i in endog.columns: 
        endog = endog.drop(i, axis = 1)
M=endog.dropna()
m=M.values
S=np.matmul(np.matrix.transpose(m),m)/len(m)
w ,v = np.linalg.eig(S)
#scree plot
plt.plot(w,markersize = 5, marker="o")
plt.show()
